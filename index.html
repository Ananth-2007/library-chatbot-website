<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Chatbot</title>
    <style>
        /* (All your CSS styles remain the same) */
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-image: url('https://images.unsplash.com/photo-1521587760476-6c12a4b040da?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .chat-container { width: 400px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; flex-direction: column; height: 80vh; }
        .chat-header { background-color: #5a67d8; color: white; padding: 16px; text-align: center; border-top-left-radius: 8px; border-top-right-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .chat-header img { width: 30px; height: 30px; margin-right: 10px; }
        .chat-messages { flex-grow: 1; padding: 16px; overflow-y: auto; background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/fancy-cushion.png'); background-repeat: repeat; }
        .chat-input { display: flex; border-top: 1px solid #ddd; padding: 10px; }
        #userInput { flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 16px; }
        #sendButton { background-color: #5a67d8; color: white; border: none; padding: 10px 15px; margin-left: 8px; border-radius: 4px; cursor: pointer; }
        .message { margin-bottom: 12px; padding: 8px 14px; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
        .user-message { background-color: #e2e8f0; color: #2d3748; align-self: flex-end; }
        .bot-message { background-color: #5a67d8; color: #ffffff; font-weight: normal; align-self: flex-start; }
        .chat-messages > div { display: flex; flex-direction: column; }
        .book-item { display: flex; align-items: center; margin-bottom: 10px; border: 1px solid #eee; padding: 8px; border-radius: 4px; background-color: #f9f9f9; cursor: pointer; transition: background-color 0.2s; color: #333; }
        .book-item:hover { background-color: #eef; }
        .book-item img { width: 80px; height: 120px; margin-right: 10px; object-fit: cover; border-radius: 2px; }
        .book-details { flex-grow: 1; }
        .book-details h4 { margin: 0 0 5px 0; color: #333; }
        .book-details p { margin: 0; font-size: 0.9em; color: #666; }
        .download-link { color: #fff; background-color: #38a169; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-top: 10px; display: inline-block;}
        .confirm-button { color: #fff; background-color: #dd6b20; padding: 8px 15px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-top: 10px; display: inline-block; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header"><img src="https://www.gstatic.com/images/branding/product/1x/chat_48dp.png" alt="Chatbot Icon"><h2>Library Assistant</h2></div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">Hello! Ask me to 'list available books', then click a book to begin booking.</div>
        </div>
        <div class="chat-input"><input type="text" id="userInput" placeholder="Type your message here..."><button id="sendButton">Send</button></div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        let conversationState = {};

        function addMessage(sender, content, isHtml = false) {
            const wrapperDiv = document.createElement('div');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            if (isHtml) { messageDiv.innerHTML = content; } 
            else { messageDiv.innerText = content; }
            wrapperDiv.appendChild(messageDiv);
            chatMessages.appendChild(wrapperDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function startBookingFromClick(bookTitle) {
            const userMessage = `book '${bookTitle.replace(/'/g, "\\'")}'`;
            addMessage('user', userMessage);
            sendMessage(userMessage);
        }

        function confirmBooking() {
            const userMessage = 'confirm';
            addMessage('user', userMessage);
            sendMessage(userMessage);
        }

        async function sendMessage(messageText) {
            const userText = messageText || userInput.value;
            if (userText.trim() === '') return;
            if (!messageText) { addMessage('user', userText); userInput.value = ''; }

            try {
                // --- THIS IS THE IMPORTANT CHANGE ---
                const response = await fetch('https://library-chatbot-website.onrender.com/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: userText, state: conversationState })
                });

                const data = await response.json();
                const botResponse = data.response;
                conversationState = botResponse.state || {};

                if (botResponse.type === "books_list") {
                    let htmlContent = "Here are the available books:<br><br>";
                    botResponse.content.forEach(book => {
                        const escapedTitle = book.title.replace(/'/g, "\\'");
                        htmlContent += `<div class="book-item" onclick="startBookingFromClick('${escapedTitle}')"><img src="${book.image_url}" alt="${book.title}"><div class="book-details"><h4>${book.title}</h4><p>by ${book.author}</p></div></div>`;
                    });
                    addMessage('bot', htmlContent, true);
                } else if (botResponse.type === "booking_success") {
                    const transactionId = botResponse.content.transaction_id;
                    const successMessage = botResponse.content.message;
                    // --- THIS URL ALSO NEEDS TO BE UPDATED ---
                    const downloadUrl = `https://library-chatbot-website.onrender.com/download_receipt/${transactionId}`;
                    let htmlContent = `${successMessage}<br><a href="${downloadUrl}" class="download-link" target="_blank">Download PDF Receipt</a>`;
                    addMessage('bot', htmlContent, true);
                } else if (botResponse.type === "prompt_confirmation") {
                    const formattedContent = botResponse.content.replace(/\n/g, '<br>');
                    let htmlContent = `${formattedContent}<br><button class="confirm-button" onclick="confirmBooking()">Confirm Booking</button>`;
                    addMessage('bot', htmlContent, true);
                } else {
                    addMessage('bot', botResponse.content);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('bot', 'Sorry, something went wrong. Please try again.');
                conversationState = {};
            }
        }
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (e) => (e.key === 'Enter' ? sendMessage() : null));
    </script>
</body>
</html>